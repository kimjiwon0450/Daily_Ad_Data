name: Facebook Ads ETL Daily Run

on:
  schedule:
    # 매일 한국 시간 오전 7시 13분 (UTC 22:13)
    - cron: '13 22 * * *'

  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
    # 1. 코드 가져오기 (main.py 등)
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2. 파이썬 설치
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. 라이브러리 설치 (중복된 줄 정리함)
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install facebook_business pandas pandas-gbq google-auth google-cloud-bigquery gspread oauth2client

    # 4. ★ [중요] 비밀 금고에서 꺼내서 파일 만들기 ★
    - name: Create Secret Files
      env:
        # 1) 시크릿 내용을 환경변수로 먼저 불러옵니다. (특수문자/줄바꿈 깨짐 방지)
        DATA_CONFIG: ${{ secrets.CONFIG_JSON }}
        DATA_SERVICE_KEY: ${{ secrets.SERVICE_KEY_JSON }} # <-- 이름 수정됨!
      run: |
        # 2) 환경변수 내용을 파일로 저장합니다.
        echo "$DATA_CONFIG" > config.json
        echo "$DATA_SERVICE_KEY" > service_key.json
        
        # 3) 파일이 잘 생성되었는지 확인 (내용은 보안상 안 보이지만 파일 크기는 보임)
        echo "config.json created:"
        ls -l config.json
        echo "service_key.json created:"
        ls -l service_key.json

    # 5. 프로그램 실행
    - name: Run ETL Script
      run: python "메타_마케팅데이터_가져오기.py"
